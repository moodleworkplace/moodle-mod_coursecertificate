{"version":3,"sources":["../src/manager.js"],"names":["define","Ajax","Notification","Templates","Str","SELECTORS","AUTOMATICSENDREGION","HIDDENWARNING","NOAUTOSENDINFO","REPORTREGION","TOGGLEAUTOMATICSEND","REVOKEISSUE","LOADING","TEMPLATES","AUTOMATICSENDALERT","ISSUESREPORT","SERVICES","UPDATEAUTOMATICSEND","setVisibility","selector","visibile","document","querySelector","classList","remove","add","toggleAutomaticSend","automaticsendregion","dataset","certificateid","automaticsend","newstatus","strings","component","get_strings","then","s","confirm","M","util","js_pending","call","methodname","args","id","result","showhiddenwarning","shownoautosendinfo","render","html","innerHTML","js_complete","fail","exception","revokeIssue","issueid","window","location","reload","init","addEventListener","e","target","closest","preventDefault","reportregion"],"mappings":"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","sourcesContent":["// This file is part of the mod_coursecertificate plugin for Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module instantiates the functionality for actions on course certificates.\n *\n * @module      mod_coursecertificate/manager\n * @package     mod_coursecertificate\n * @copyright   2020 Mikel Mart√≠n <mikel@moodle.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n    'core/ajax',\n    'core/notification',\n    'core/templates',\n    'core/str'\n], function(\n    Ajax,\n    Notification,\n    Templates,\n    Str\n) {\n\n    /** @type {Object} The list of selectors for the coursecertificate module. */\n    const SELECTORS = {\n        AUTOMATICSENDREGION: \"[data-region='automaticsend-alert']\",\n        HIDDENWARNING: \".hidden-warning\",\n        NOAUTOSENDINFO: \".noautosend-info\",\n        REPORTREGION: \"[data-region='issues-report']\",\n        TOGGLEAUTOMATICSEND: \"[data-action='toggle-automaticsend']\",\n        REVOKEISSUE: \"[data-action='revoke-issue']\",\n        LOADING: \".loading-overlay\"\n    },\n    /** @type {Object} The list of templates for the coursecertificate module. */\n    TEMPLATES = {\n        AUTOMATICSENDALERT: 'mod_coursecertificate/automaticsend_alert',\n        ISSUESREPORT: 'mod_coursecertificate/issues_report'\n    },\n    /** @type {Object} The list of services for the coursecertificate module. */\n    SERVICES = {\n        UPDATEAUTOMATICSEND: 'mod_coursecertificate_update_automaticsend',\n        REVOKEISSUE: 'tool_certificate_revoke_issue',\n    };\n\n    /**\n     * Show/Hide selector.\n     *\n     * @param {string} selector\n     * @param {boolean} visibile\n     */\n    function setVisibility(selector, visibile) {\n        if (visibile) {\n            document.querySelector(selector).classList.remove('d-none');\n            document.querySelector(selector).classList.remove('invisible');\n        } else {\n            document.querySelector(selector).classList.add('d-none');\n            document.querySelector(selector).classList.add('invisible');\n        }\n    }\n\n    /**\n     * Toggle the automaticsend setting on/off for coursecertificate.\n     *\n     * @param {Element} automaticsendregion\n     */\n    function toggleAutomaticSend(automaticsendregion) {\n        const {certificateid, automaticsend} =\n            automaticsendregion.querySelector(SELECTORS.TOGGLEAUTOMATICSEND).dataset;\n        const newstatus = automaticsend === '0';\n        const strings = newstatus\n        // Load strings depending on newstatus.\n        ? [{'key': 'confirmation', component: 'admin'},\n            {'key': 'enableautomaticsendpopup', component: 'coursecertificate'},\n            {'key': 'confirm'},\n            {'key': 'cancel'}]\n        : [{'key': 'confirmation', component: 'admin'},\n            {'key': 'disableautomaticsend', component: 'coursecertificate'},\n            {'key': 'confirm'},\n            {'key': 'cancel'}];\n        Str.get_strings(strings).then((s) => {\n            // Show confirm notification.\n            Notification.confirm(s[0], s[1], s[2], s[3], () => {\n                M.util.js_pending('mod_coursecertificate_toggle_automaticsend');\n                // Show loading template.\n                setVisibility(SELECTORS.LOADING, true);\n                // Call to webservice.\n                Ajax.call([{methodname: SERVICES.UPDATEAUTOMATICSEND,\n                    args: {id: certificateid, automaticsend: newstatus}}])[0]\n                // Reload automatic send alert template.\n                .then((result) => {\n                    let {showhiddenwarning, shownoautosendinfo} = result;\n                    Templates.render(TEMPLATES.AUTOMATICSENDALERT,\n                        {certificateid: certificateid, automaticsend: newstatus}, '')\n                        .then((html) => {\n                            automaticsendregion.innerHTML = html;\n                            setVisibility(SELECTORS.HIDDENWARNING, showhiddenwarning);\n                            setVisibility(SELECTORS.NOAUTOSENDINFO, shownoautosendinfo);\n                            M.util.js_complete('mod_coursecertificate_toggle_automaticsend');\n                            return null;\n                        })\n                        .fail(Notification.exception);\n                    return null;\n                })\n                .fail(Notification.exception);\n            });\n            return null;\n        }).fail(Notification.exception);\n    }\n\n    /**\n     * Revoke the issue.\n     *\n     * @param {int} issueid\n     */\n    function revokeIssue(issueid) {\n        const strings = [{'key': 'confirmation', component: 'admin'},\n            {'key': 'revokeissue', component: 'coursecertificate'},\n            {'key': 'confirm'},\n            {'key': 'cancel'}];\n        Str.get_strings(strings).then((s) => {\n            // Show confirm notification.\n            Notification.confirm(s[0], s[1], s[2], s[3], () => {\n                M.util.js_pending('mod_coursecertificate_revoke_issue');\n                // Call to webservice to revoke issue.\n                Ajax.call([{methodname: SERVICES.REVOKEISSUE, args: {id: issueid}}])[0]\n                // Call to webservice to get updated table.\n                .then(() => {\n                    M.util.js_complete('mod_coursecertificate_revoke_issue');\n                    window.location.reload();\n                    return null;\n                })\n                .fail(Notification.exception);\n            });\n            return null;\n        }).fail(Notification.exception);\n    }\n\n    return {\n        init: function() {\n            const automaticsendregion = document.querySelector(SELECTORS.AUTOMATICSENDREGION);\n            if (automaticsendregion) {\n                automaticsendregion.addEventListener('click', (e) => {\n                    if (e.target && e.target.closest(SELECTORS.TOGGLEAUTOMATICSEND)) {\n                        e.preventDefault();\n                        toggleAutomaticSend(automaticsendregion);\n                    }\n                });\n            }\n            const reportregion = document.querySelector(SELECTORS.REPORTREGION);\n            if (reportregion) {\n                reportregion.addEventListener('click', (e) => {\n                    const target = e.target && e.target.closest(SELECTORS.REVOKEISSUE);\n                    if (target) {\n                        e.preventDefault();\n                        const {issueid} = target.dataset;\n                        revokeIssue(issueid);\n                    }\n                });\n            }\n        }\n    };\n});"],"file":"manager.min.js"}